#include <NihilEngine/Noise.h>
#include <algorithm>
#include <cmath>
#include <random>

namespace NihilEngine {

    Noise::Noise(unsigned int seed) {
        // Initialiser la table de permutation
        p.resize(512);

        // Table de gradients 3D standard
        std::vector<int> permutation = {
            151,160,137,91,90,15,131,13,201,95,96,53,194,233,7,225,140,36,103,30,69,142,
            8,99,37,240,21,10,23,190,6,148,247,120,234,75,0,26,197,62,94,252,219,203,117,
            35,11,32,57,177,33,88,237,149,56,87,174,20,125,136,171,168,68,175,74,165,
            71,134,139,48,27,166,77,146,158,231,49,210,109,183,26,81,102,169,8,81,59,
            132,187,225,254,143,124,188,243,107,40,38,125,140,47,209,23,165,163,218,212,
            242,93,169,50,144,210,39,91,41,130,83,37,251,218,119,31,188,113,1,190,36,
            28,196,148,246,185,61,255,101,116,45,161,134,170,125,61,181,8,249,216,47,
            134,211,241,93,158,4,187,144,2,100,175,231,92,177,187,53,17,51,149,198,222,
            207,17,141,198,248,1,223,189,108,183,66,39,101,141,253,229,203,19,87,154,
            179,85,90,98,66,31,150,16,142,195,56,70,169,196,186,171,248,150,161,187,221,
            43,124,94,86,253,62,99,212,224,163,14,186,190,159,65,249,113,84,166,180,7,
            102,89,255,208,141,153,44,239,227,60,51,236,139,59,158,128,224,189,5,110,67,
            138,156,66,90,196,163,53,64,98,44,226,13,110,85,150,235,0,153,185,120,227,221,
            115,77,193,136,81,56,241,25,149,9,237,164,111,232,40,166,228,125,61,201,37,
            147,107,6,123,140,68,18,166,26,154,131,36,19,152,160,41,176,221,29,56,190,
            17,46,124,156,118,50,142,252,97,54,222,46,28,158,228,157,184,39,94,19,47,54,
            231,12,26,73,23,204,245,39,249,230,97,173,252,41,7,203,65,85,237,252,140,4,
            29,53,233,74,31,237,244,91,62,42,129,179,155,26,198,208,53,133,136,180,50,6,
            169,218,148,13,141,93,194,150,91,171,60,154,47,43,174,49,67,152,97,103,69,159,
            195,204,169, 90,3,91,19,56,78,8,44,43,238,133,5,45,184,79,202,101,83,170,177,
            40,141,113,140,46,168,120,21,2,119,226,130,1,96,190,88,81,108,89,199,210,208,
            160,130,100,52,140,101,44,43,26,141,10,130,28,251,54,141,0,76,169,101,44,74,
            207,20,125,57,111,23,11,60,57,175,7,211,112,215,232,108,9,6,224,237,62,55,
            151,46,245,41,159,13,63,35,81,24,226,199,87,203,147,59,105,217,71,17,190,198,
            187,39,33,101,120,99,3,208,252,151,185,89,84,6,96,223,137,138,49,173,124,40,
            229,37,16,73,149,170,209,131,156,98,41,177,143,219,235,205,65,86,45,146,208,
            118,198,79,125,36,28,238,122,169,38,85,107,49,73,70,199,196,244,60,201,6,196,
            154,36,3,107,52,245,41,154,174,27,35,241,30,196,87,106,199,166,78,171,72,77,
            0,84,181,11,162,33,131,8,10,9,104,6,0,79,29,232,26,119,34,115,68,59,82,25,
            130,228,48,221,35,25,165,107,2,7,21,43,4,38,50,14,32,144,10,39,6,96,70,43,
            83,13,90,31,63,99,25,19,49,36,209,57,231,48,229,88,188,150,14,88,9,14,155,
            140,90,8,145,54,150,56,59,123,58,5,66,150,136,201,44,159,51,220,43,82,109,
            190,63,13,82,58,114,71,32,29,106,248,97,53,20,70,136,4,53,17,35,134,54,14,
            77,105,190,147,84,133,101,78,25,220,151,29,85,24,64,79,63,118,122,20,232,252,
            207,17,106,114,188,67,103,32,122,59,81,41,224,25,36,93,70,133,1,100,3,162,
            105,16,160,210,205,96,119,243,252,234,207,1,64,255,101,80,253,204,186,73,127,
            124,72,38,44,163,70,221,40,210,105,97,159,14,76,4,155,101,112,14,77,99,109,
            231,203,219,120,41,118,46,27,93,116,5,3,52,241,113,58,222,130,64,12,3,14,97,
            50,27,255,107,6,191,7,21,144,253,219,52,2,190,16,127,111,219,45,237,107,53,
            166,196,130,30,50,49,167,196,89,43,74,108,195,81,175,25,34,168,164,23,185,160,
            99,235,193,75,197,129,184,192,139,59,246,162,218,79,239,108,11,202,29,183,249,
            143,43,12,2,240,74,26,83,165,177,153,232,53,89,150,39,34,43,27,109,108,171,
            51,145,12,207,55,77,30,122,154,81,255,168,249,216,80,187,106,46,16,73,188,84,
            18,56,200,84,153,47,75,164,96,224,91,76,56,39,56,36,89,138,28,12,224,118,208,
            47,165,194,170,46,173,205,79,56,81,43,40,238,27,68,63,52,12,10,6,30,144,251,
            224,155,117,41,149,180,194,24,49,23,102,6,84,8,181,21,43,91,48,165,16,251,54,
            7,58,154,181,201,61,129,52,58,160,93,85,26,20,78,8,161,112,32,84,35,25,43,66,
            101,98,36,4,190,73,222,83,220,132,62,215,122,87,19,237,56,87,174,20,251,68,52,
            174,173,210,100,133,75,220,79,20,42,163,35,98,108,161,47,7,82,6,46,122,43,87,
            56,163,118,236,116,26,227,199,202,156,137,59,211,215,163,220,40,115,152,50,53,
            187,222,65,52,25,31,230,107,58,126,75,74,121,69,103,45,222,73,228,124,143,176,
            26,189,224,168,53,9,78,73,84,171,129,212,180,155,112,111,214,124,121,35,3,58,
            75,192,161,42,23,67,190,220,240,82,99,37,85,179,62,177,172,50,107,210,205,186,
            141,170,181,43,169,194,56,100,211,201,11,43,154,35,3,14,5,61,53,3,25,29,238,
            63,23,158,68,190,61,40,28,30,42,178,59,60,54,101,124,68,60,63,19,93,203,49,86,
            2,18,232,158,66,26,185,47,41,125,195,78,161,208,130,160,4,68,99,61,253,8,1,
            33,71,187,33,148,0,39,210,184,147,77,62,130,87,250,240,21,186,171,68,175,33,
            92,51,195,120,96,18,116,186,198,236,197,156,168,150,65,32,22,236,17,98,33,39,
            13,54,47,15,6,107,56,200,41,158,192,155,87,42,166,50,96,136,251,118,124,61,129,
            56,0,53,96,3,158,188,24,143,121,146,178,85,161,102,64,59,9,103,6,15,157,97,18,
            56,169,48,170,103,4,151,97,54,144,12,86,31,115,251,193,134,99,53,45,14,25,165,
            108,161,57,41,229,204,228,250,117,143,43,161,80,150,171,49,23,120,15,161,60,52,
            43,25,161,118,2,78,50,171,255,77,148,64,127,126,45,154,247,40,52,104,140,211,
            35,43,178,232,68,74,173,146,49,27,150,156,87,160,22,104,194,59,248,250,40,148,
            79,157,94,207,36,252,136,12,34,98,82,41,7,3,5,204,162,10,236,18,130,67,144,171,
            168,42,168,125,251,212,83,178,73,189,10,54,63,41,204,72,4,18,245,210,136,148,
            223,52,165,228,146,114,0,192,44,176,173,199,235,64,252,134,15,81,21,174,26,3,
            113,39,247,204,76,81,171,5,25,30,191,84,21,108,197,75,87,237,79,44,169,68,178,
            121,75,255,131,172,224,242,82,218,231,59,254,40,90,252,157,247,51,173,163,58,
            128,103,230,65,50,68,25,157,193,210,100,78,189,216,241,45,250,74,122,100,151,
            16,59,205,171,223,29,141,47,137,15,80,6,177,23,183,202,14,105,139,34,164,100,
            241,187,165,59,150,105,150,32,22,76,17,8,13,45,152,229,224,59,81,170,143,3,1,
            27,60,208,234,202,18,2,227,26,106,82,30,85,73,174,191,208,67,231,56,101,130,
            41,13,10,171,5,17,253,19,175,43,83,27,202,121,73,51,40,103,146,142,243,173,9,
            19,87,65,179,20,63,108,186,38,179,65,181,118,120,16,139,226,198,238,227,24,49,
            197,176,21,59,111,246,97,228,251,67,25,167,63,161,64,72,11,121,172,150,91,33,
            200,246,16,183,33,153,177,84,254,180,50,39,153,7,169,31,180,81,196,104,165,30,
            75,19,238,59,9,60,46,184,7,86,3,81,165,201,129,23,102,125,158,148,22,84,51,65,
            122,101,45,43,96,98,1,253,201,213,40,254,72,26,220,169,197,37,48,1,155,247,189,
            25,16,161,185,197,189,170,159,152,157,22,43,129,192,210,107,58,14,110,85,148,
            177,41,57,171,151,32,84,59,156,1,253,3,171,19,75,15,9,251,201,2,57,141,47,188,
            235,87,191,217,208,57,150,91,46,45,229,2,72,44,138,36,200,165,40,39,119,230,191,
            219,173,41,177,51,35,250,0,189,232,113,143,60,71,237,9,10,91,6,81,50,134,160,
            61,103,163,192,91,5,162,87,7,24,205,45,152,173,42,103,158,141,53,25,36,15,65,
            30,226,68,28,64,94,70,30,67,89,35,125,140,13,75,161,242,208,196,189,53,133,195,
            207,128,158,161,94,164,220,47,65,50,205,197,57,8,110,96,246,4,181,51,33,179,63,
            70,216,3,38,154,102,200,206,73,60,112,181,29,224,151,100,53,33,59,31,123,44,49,
            119,89,2,208,44,201,202,137,160,63,208,1,64,43,222,8,177,245,94,245,81,9,230,
            154,40,73,178,134,228,251,71,241,103,161,222,74,8,99,6,87,14,106,228,72,138,23,
            42,195,171,81,253,131,208,74,191,147,114,249,170,21,196,190,163,135,246,6,173,
            130,44,180,79,11,191,251,50,187,49,12,144,56,62,101,82,255,168,51,6,35,168,4,
            169,45,85,250,159,2,207,141,249,1,198,79,184,168,41,58,205,110,59,66,18,221,2,
            62,6,237,44,20,70,226,204,74,176,106,56,198,24,10,248,53,238,35,47,58,107,11,
            50,51,9,21,220,237,160,3,64,252,8,6,183,210,44,199,57,242,238,44,201,189,29,30,
            18,53,222
        };

        // Mélanger avec le seed
        std::mt19937 gen(seed);
        std::shuffle(permutation.begin(), permutation.end(), gen);

        // Dupliquer pour éviter les débordements
        for (int i = 0; i < 256; ++i) {
            p[i] = permutation[i];
            p[256 + i] = permutation[i];
        }
    }

    float Noise::fade(float t) const {
        return t * t * t * (t * (t * 6 - 15) + 10);
    }

    float Noise::lerp(float a, float b, float t) const {
        return a + t * (b - a);
    }

    float Noise::grad(int hash, float x, float y, float z) const {
        int h = hash & 15;
        float u = h < 8 ? x : y;
        float v = h < 4 ? y : h == 12 || h == 14 ? x : z;
        return ((h & 1) == 0 ? u : -u) + ((h & 2) == 0 ? v : -v);
    }

    float Noise::perlin2D(float x, float y) const {
        int X = (int)std::floor(x) & 255;
        int Y = (int)std::floor(y) & 255;

        x -= std::floor(x);
        y -= std::floor(y);

        float u = fade(x);
        float v = fade(y);

        int A = p[X] + Y;
        int AA = p[A];
        int AB = p[A + 1];
        int B = p[X + 1] + Y;
        int BA = p[B];
        int BB = p[B + 1];

        return lerp(v, lerp(u, grad(p[AA], x, y, 0), grad(p[BA], x - 1, y, 0)),
                    lerp(u, grad(p[AB], x, y - 1, 0), grad(p[BB], x - 1, y - 1, 0)));
    }

    float Noise::perlin3D(float x, float y, float z) const {
        int X = (int)std::floor(x) & 255;
        int Y = (int)std::floor(y) & 255;
        int Z = (int)std::floor(z) & 255;

        x -= std::floor(x);
        y -= std::floor(y);
        z -= std::floor(z);

        float u = fade(x);
        float v = fade(y);
        float w = fade(z);

        int A = p[X] + Y;
        int AA = p[A] + Z;
        int AB = p[A + 1] + Z;
        int B = p[X + 1] + Y;
        int BA = p[B] + Z;
        int BB = p[B + 1] + Z;

        return lerp(w, lerp(v, lerp(u, grad(p[AA], x, y, z), grad(p[BA], x - 1, y, z)),
                                lerp(u, grad(p[AB], x, y - 1, z), grad(p[BB], x - 1, y - 1, z))),
                    lerp(v, lerp(u, grad(p[AA + 1], x, y, z - 1), grad(p[BA + 1], x - 1, y, z - 1)),
                                lerp(u, grad(p[AB + 1], x, y - 1, z - 1), grad(p[BB + 1], x - 1, y - 1, z - 1))));
    }

    float Noise::simplex2D(float x, float y) const {
        // Implémentation simplifiée de Simplex noise 2D
        // Pour une vraie implémentation, voir les sources OpenSimplex
        return perlin2D(x, y); // Placeholder
    }

    float Noise::fractal(float x, float y, int octaves, float persistence, float scale) const {
        float value = 0.0f;
        float amplitude = 1.0f;
        float frequency = scale;

        for (int i = 0; i < octaves; ++i) {
            value += perlin2D(x * frequency, y * frequency) * amplitude;
            amplitude *= persistence;
            frequency *= 2.0f;
        }

        return value;
    }

    float Noise::ridged(float x, float y, int octaves, float persistence, float scale) const {
        float value = 0.0f;
        float amplitude = 1.0f;
        float frequency = scale;

        for (int i = 0; i < octaves; ++i) {
            float n = perlin2D(x * frequency, y * frequency);
            n = std::abs(n);
            n = 1.0f - n;
            n = n * n;
            value += n * amplitude;
            amplitude *= persistence;
            frequency *= 2.0f;
        }

        return value;
    }
}